<!DOCTYPE html>
<!-- Change base background color -->
<html lang="en" class="h-full bg-neutral-950">

<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js and date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Load Chart.js zoom plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <style>
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #555; /* Darker scrollbar thumb */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Ensure smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>

<!-- Change base text color -->
<body class="h-full flex flex-col font-sans text-neutral-200 antialiased">

    <!-- Header -->
    <!-- Updated header colors for dark theme -->
    <header class="bg-neutral-900 text-white shadow-md sticky top-0 z-50 border-b border-neutral-800">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Title -->
                <div class="flex items-center">
                    <!-- Changed icon color to emerald -->
                    <svg class="h-8 w-8 text-emerald-400 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M7.5 8.25h9m-9 3H12m-6.75 3h9m-9 3H12m-6.75 3h9m-9 3H12m-6.75 3h9m-9 3H12m-6.75 3h9m-9 3H12m6.3-15.187.01-.004c1.44-.002 2.843.297 4.126.865a7.5 7.5 0 0 1 2.22 2.22c.568 1.283.865 2.686.865 4.126s-.297 2.843-.865 4.126a7.5 7.5 0 0 1-2.22 2.22c-1.283.568-2.686.865-4.126.865-1.44.002-2.843-.297-4.126-.865a7.5 7.5 0 0 1-2.22-2.22c-.568-1.283-.865-2.686-.865-4.126s.297-2.843.865-4.126a7.5 7.5 0 0 1 2.22-2.22c1.283-.568 2.686.865 4.126-.865Z" />
                    </svg>
                    <h1 class="text-xl font-bold">Fuel Mileage Tracker</h1>
                </div>
                <!-- Action Buttons -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <!-- Changed button color to emerald -->
                    <button id="import-csv-btn"
                        class="flex items-center bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-3 sm:px-4 py-2 rounded-lg shadow transition duration-150 ease-in-out">
                        <svg class="h-5 w-5 mr-0 sm:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" />
                        </svg>
                        <span class="hidden sm:inline">Import CSV</span>
                    </button>
                    <!-- Kept export blue for visual distinction -->
                    <button id="export-csv-btn"
                        class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold px-3 sm:px-4 py-2 rounded-lg shadow transition duration-150 ease-in-out">
                        <svg class="h-5 w-5 mr-0 sm:mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span class="hidden sm:inline">Export CSV</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <!-- Updated tab colors for dark theme -->
    <nav class="bg-neutral-900 shadow-md sticky top-16 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex -mb-px">
                <!-- Active tab styles updated -->
                <button id="tab-dashboard" data-tab="dashboard"
                    class="tab-btn border-b-2 border-emerald-500 text-emerald-400 py-3 px-4 font-semibold text-sm sm:text-base">
                    Dashboard
                </button>
                <!-- Inactive tab styles updated -->
                <button id="tab-add" data-tab="add"
                    class="tab-btn border-b-2 border-transparent text-neutral-400 hover:text-neutral-100 hover:border-neutral-700 py-3 px-4 font-semibold text-sm sm:text-base">
                    Add New Entry
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <!-- Updated main background color -->
    <main class="flex-1 overflow-y-auto bg-neutral-950 p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">

            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="tab-content space-y-6">
                <!-- Welcome/No Data Message -->
                <!-- Updated message colors for dark theme -->
                <div id="no-data-message"
                    class="hidden bg-neutral-800 border-l-4 border-emerald-600 p-4 rounded-md shadow">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-emerald-300">
                                Welcome! No data found. Please
                                <button id="import-from-message-btn" class="font-bold underline hover:text-emerald-100">
                                    import your CSV file
                                </button>
                                to get started.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div id="stats-grid" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Stat Card: Total KMs -->
                    <!-- Updated card styles for dark theme -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm relative overflow-hidden">
                        <!-- FIX: Changed class_A to class -->
                        <!-- FIX: Updated icon, size, and opacity -->
                        <div class="absolute top-4 right-4 text-neutral-700 opacity-30">
                            <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.994 0h-4.992" />
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-neutral-400 truncate">Total Kilometers</h3>
                        <!-- FIX: Removed mt-1 for tighter grouping -->
                        <p id="stat-total-kms" class="text-3xl font-semibold text-neutral-100">0</p>
                    </div>
                    <!-- Stat Card: Total Volume -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm relative overflow-hidden">
                        <!-- FIX: Updated icon, size, and opacity -->
                        <div class="absolute top-4 right-4 text-neutral-700 opacity-30">
                            <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082M9.75 3.104a2.25 2.25 0 00-2.25 2.25c0 1.131.91 2.04 2.008 2.214M14.25 14.5l-4.1-3.879a2.25 2.25 0 01-.659-1.591V3.104m0 0c.251.023.501.05.75.082m0 0a2.25 2.25 0 012.25 2.25c0 1.131-.91 2.04-2.008 2.214m0 0L14.25 14.5M12 18.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" />
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-neutral-400 truncate">Total Volume (Ltr)</h3>
                        <!-- FIX: Removed mt-1 for tighter grouping -->
                        <p id="stat-total-volume" class="text-3xl font-semibold text-neutral-100">0</p>
                    </div>
                    <!-- Stat Card: Total Spent -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm relative overflow-hidden">
                        <!-- FIX: Updated icon, size, and opacity -->
                        <div class="absolute top-4 right-4 text-neutral-700 opacity-30">
                            <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6M3.75 16.5h16.5a1.5 1.5 0 001.5-1.5V6.75a1.5 1.5 0 00-1.5-1.5H3.75a1.5 1.5 0 00-1.5 1.5v8.25a1.5 1.5 0 001.5 1.5z" />
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-neutral-400 truncate">Total Spent (Rs)</h3>
                        <!-- FIX: Removed mt-1 for tighter grouping -->
                        <p id="stat-total-spent" class="text-3xl font-semibold text-neutral-100">0</p>
                    </div>
                    <!-- Stat Card: Average Mileage -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm relative overflow-hidden">
                        <!-- FIX: Updated icon, size, and opacity -->
                        <div class="absolute top-4 right-4 text-neutral-700 opacity-30">
                            <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-neutral-400 truncate">Average Mileage</h3>
                        <!-- FIX: Removed mt-1 for tighter grouping -->
                        <p id="stat-avg-mileage" class="text-3xl font-semibold text-neutral-100">0</p>
                    </div>
                    <!-- Stat Card: Total Days -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm col-span-2 md:col-span-1 lg:col-span-1 relative overflow-hidden">
                        <!-- FIX: Updated icon, size, and opacity -->
                        <div class="absolute top-4 right-4 text-neutral-700 opacity-30">
                            <svg class="h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v.75m0 16.5V21m10.5-18v.75m0 16.5V21M3 10.5h18M3 7.5h18M3 13.5h18M3 16.5h18M4.5 3h15a1.5 1.5 0 011.5 1.5v15a1.5 1.5 0 01-1.5 1.5h-15a1.5 1.5 0 01-1.5-1.5v-15a1.5 1.5 0 011.5-1.5z" />
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-neutral-400 truncate">Total Days</h3>
                        <!-- FIX: Removed mt-1 for tighter grouping -->
                        <p id="stat-total-days" class="text-3xl font-semibold text-neutral-100">0</p>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Petrol Price Chart -->
                    <!-- Updated chart card styles -->
                    <div class="lg:col-span-2 bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-neutral-100">Petrol Price Over Time</h3>
                            <!-- Updated reset button styles -->
                            <button id="reset-zoom-btn"
                                class="text-xs bg-neutral-700 hover:bg-neutral-600 text-neutral-200 px-3 py-1 rounded-full hidden">Reset
                                Zoom</button>
                        </div>
                        <div class="relative h-64 md:h-96">
                            <canvas id="price-chart"></canvas>
                        </div>
                    </div>

                    <!-- Best Mileage Chart -->
                    <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-neutral-100 mb-4">Top 5 Best Mileage (Km/L)</h3>
                        <div class="relative h-64 md:h-96">
                            <canvas id="mileage-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add New Entry Tab -->
            <div id="content-add" class="tab-content hidden">
                <!-- Updated form card styles -->
                <div class="max-w-xl mx-auto bg-neutral-900 border border-neutral-800 p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-neutral-100 mb-6">Add New Petrol Fill-Up</h2>
                    <form id="add-entry-form" class="space-y-6">
                        <!-- Filled Date -->
                        <div>
                            <!-- Updated label and input styles -->
                            <label for="filled-date" class="block text-sm font-medium text-neutral-300">Filled Date</label>
                            <input type="date" id="filled-date"
                                class="mt-1 block w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm text-neutral-100"
                                required>
                        </div>

                        <!-- Petrol Price -->
                        <div>
                            <label for="petrol-price" class="block text-sm font-medium text-neutral-300">Petrol Price (per
                                Liter)</label>
                            <input type="number" id="petrol-price" step="0.01" min="0"
                                class="mt-1 block w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm text-neutral-100 placeholder-neutral-500"
                                placeholder="e.g., 102.50" required>
                        </div>

                        <!-- Petrol Volume -->
                        <div>
                            <label for="petrol-volume" class="block text-sm font-medium text-neutral-300">Petrol Volume
                                (Liters)</label>
                            <input type="number" id="petrol-volume" step="0.01" min="0"
                                class="mt-1 block w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm text-neutral-100 placeholder-neutral-500"
                                placeholder="e.g., 5.5" required>
                        </div>

                        <!-- Start KMS -->
                        <div>
                            <label for="start-kms" class="block text-sm font-medium text-neutral-300">Start KMS
                                (Odometer)</label>
                            <!-- Updated readonly input styles -->
                            <input type="number" id="start-kms"
                                class="mt-1 block w-full px-3 py-2 bg-neutral-800 opacity-70 border border-neutral-700 rounded-md shadow-sm sm:text-sm text-neutral-100"
                                readonly>
                            <p class="mt-1 text-xs text-neutral-500">Auto-filled from last entry's End KMS.</p>
                        </div>

                        <!-- End KMS -->
                        <div>
                            <label for="end-kms" class="block text-sm font-medium text-neutral-300">End KMS
                                (Odometer)</label>
                            <input type="number" id="end-kms" step="0.1" min="0"
                                class="mt-1 block w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm text-neutral-100 placeholder-neutral-500"
                                placeholder="Enter current odometer reading" required>
                        </div>

                        <!-- Submit Button -->
                        <div>
                            <!-- Updated button styles -->
                            <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out">
                                Save Entry
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="csv-file-input" accept=".csv" class="hidden">

    <!-- Modal: New Entry Summary -->
    <div id="summary-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Updated modal panel styles -->
        <div
            class="bg-neutral-900 border border-neutral-700 rounded-lg shadow-xl max-w-md w-full overflow-hidden transform transition-all sm:my-8 opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            id="summary-modal-panel">
            <div class="bg-neutral-900 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <!-- Updated icon background -->
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-800/30 sm:mx-0 sm:h-10 sm:w-10">
                        <!-- Updated icon color -->
                        <svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <!-- Updated text colors -->
                        <h3 class="text-lg leading-6 font-medium text-neutral-100" id="modal-title">Entry Saved!</h3>
                        <div class="mt-4 space-y-3">
                            <div>
                                <h4 class="text-sm font-semibold text-neutral-300">Completed Tank Stats:</h4>
                                <ul class="text-sm text-neutral-400 list-disc list-inside">
                                    <li id="summary-mileage"></li>
                                    <li id="summary-kms"></li>
                                    <li id="summary-days"></li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-neutral-300">New Fill-Up:</h4>
                                <ul class="text-sm text-neutral-400 list-disc list-inside">
                                    <li id="summary-cost"></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Updated modal footer styles -->
            <div class="bg-neutral-950 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-summary-modal-btn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm transition-all">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Import Confirmation / Error -->
    <div id="import-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden"
        role="dialog" aria-modal="true">
        <div
            class="bg-neutral-900 border border-neutral-700 rounded-lg shadow-xl max-w-md w-full overflow-hidden transform transition-all sm:my-8 opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            id="import-modal-panel">
            <div class="bg-neutral-900 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <!-- Icon placeholder -->
                    <div id="import-modal-icon-container" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full sm:mx-0 sm:h-10 sm:w-10">
                        <!-- JS will insert success (green) or error (red) icon -->
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-neutral-100" id="import-modal-title">Import Status</h3>
                        <div class="mt-2">
                            <p class="text-sm text-neutral-400" id="import-modal-message">
                                <!-- JS will insert message -->
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-neutral-950 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-import-modal-btn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm transition-all">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        /* Main Application Script */

        // --- DATA ---
        let mileageData = []; // Main data store
        let priceChart;
        let mileageChart;

        // --- DARK MODE CHART COLORS ---
        const gridColor = 'rgba(255, 255, 255, 0.1)';
        const tickColor = 'rgba(163, 163, 163, 1)'; // neutral-400
        const titleColor = 'rgba(245, 245, 245, 1)'; // neutral-100
        const accentColor = 'rgba(16, 185, 129, 1)'; // emerald-500
        const accentColorBg = 'rgba(16, 185, 129, 0.2)';
        const accentColorBar = 'rgba(16, 185, 129, 0.6)';
        const tooltipBgColor = '#171717'; // neutral-900

        // --- DOM ELEMENTS ---
        const tabDashboard = document.getElementById('tab-dashboard');
        const tabAdd = document.getElementById('tab-add');
        const contentDashboard = document.getElementById('content-dashboard');
        const contentAdd = document.getElementById('content-add');
        const addEntryForm = document.getElementById('add-entry-form');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const importFromMessageBtn = document.getElementById('import-from-message-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const noDataMessage = document.getElementById('no-data-message');
        const statsGrid = document.getElementById('stats-grid');
        const formStartKms = document.getElementById('start-kms');

        // Modals
        const summaryModal = document.getElementById('summary-modal');
        const summaryModalPanel = document.getElementById('summary-modal-panel');
        const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
        const importModal = document.getElementById('import-modal');
        const importModalPanel = document.getElementById('import-modal-panel');
        const closeImportModalBtn = document.getElementById('close-import-modal-btn');
        const resetZoomBtn = document.getElementById('reset-zoom-btn');


        // --- APPLICATION LOGIC ---

        /**
         * Initializes the application, loads data, and sets up listeners.
         */
        function initApp() {
            // Setup Tab Listeners
            tabDashboard.addEventListener('click', () => switchTab('dashboard'));
            tabAdd.addEventListener('click', () => switchTab('add'));

            // Setup Form Listener
            addEntryForm.addEventListener('submit', handleFormSubmit);

            // Setup Button Listeners
            [importCsvBtn, importFromMessageBtn].forEach(btn => {
                btn.addEventListener('click', () => csvFileInput.click());
            });
            csvFileInput.addEventListener('change', handleFileImport);
            exportCsvBtn.addEventListener('click', handleFileExport);

            // Setup Modal Listeners
            closeSummaryModalBtn.addEventListener('click', () => hideModal(summaryModal, summaryModalPanel));
            closeImportModalBtn.addEventListener('click', () => hideModal(importModal, importModalPanel));
            resetZoomBtn.addEventListener('click', () => {
                priceChart?.resetZoom();
                resetZoomBtn.classList.add('hidden');
            });

            // Load initial data from localStorage
            loadData();
        }

        /**
         * Loads data from localStorage and updates the UI.
         */
        function loadData() {
            const storedData = localStorage.getItem('mileageData');
            if (storedData) {
                mileageData = JSON.parse(storedData);
            }

            if (mileageData.length > 0) {
                // *** FIX: Show grid and hide message *before* processing ***
                statsGrid.classList.remove('hidden');
                noDataMessage.classList.add('hidden');

                // Ensure data is sorted by Filled date
                mileageData.sort((a, b) => new Date(a.filledDate) - new Date(b.filledDate));
                updateUI();
            } else {
                // Show "No data" message
                noDataMessage.classList.remove('hidden');
                statsGrid.classList.add('hidden');
                // Clear any existing chart data
                updateCharts([], []);
            }
        }

        /**
         * Saves the current data array to localStorage.
         */
        function saveData() {
            // Sort data before saving
            mileageData.sort((a, b) => new Date(a.filledDate) - new Date(b.filledDate));
            localStorage.setItem('mileageData', JSON.stringify(mileageData));
        }

        /**
         * Switches the active tab and content.
         */
        function switchTab(tabName) {
            const isDashboard = tabName === 'dashboard';

            // Update tab styles
            tabDashboard.classList.toggle('border-emerald-500', isDashboard);
            tabDashboard.classList.toggle('text-emerald-400', isDashboard);
            tabDashboard.classList.toggle('border-transparent', !isDashboard);
            tabDashboard.classList.toggle('text-neutral-400', !isDashboard);

            tabAdd.classList.toggle('border-emerald-500', !isDashboard);
            tabAdd.classList.toggle('text-emerald-400', !isDashboard);
            tabAdd.classList.toggle('border-transparent', isDashboard);
            tabAdd.classList.toggle('text-neutral-400', isDashboard);

            // Show/hide content
            contentDashboard.classList.toggle('hidden', !isDashboard);
            contentAdd.classList.toggle('hidden', isDashboard);

            // Update form defaults if switching to 'add' tab
            if (!isDashboard && mileageData.length > 0) {
                const lastEntry = mileageData[mileageData.length - 1];
                if (lastEntry.endKms) {
                    formStartKms.value = lastEntry.endKms.toFixed(1);
                } else {
                    formStartKms.value = ''; // Handle case where last entry isn't complete
                }
            } else if (!isDashboard && mileageData.length === 0) {
                // If it's the first entry ever, clear the startKms
                formStartKms.value = '';
                // And make it editable
                formStartKms.readOnly = false;
                formStartKms.classList.remove('opacity-70', 'bg-neutral-800');
                formStartKms.classList.add('bg-neutral-800'); // Ensure correct bg
            } else if (!isDashboard) {
                // Subsequent entries, make it readonly again
                formStartKms.readOnly = true;
                formStartKms.classList.add('opacity-70', 'bg-neutral-800');
            }
        }

        /**
         * Handles the "Add New Entry" form submission.
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const startKmsValue = parseFloat(document.getElementById('start-kms').value);

            // 1. Get data from form
            const newEntry = {
                id: mileageData.length + 1,
                filledDate: document.getElementById('filled-date').value,
                pricePerLiter: parseFloat(document.getElementById('petrol-price').value),
                volume: parseFloat(document.getElementById('petrol-volume').value),
                startKms: isNaN(startKmsValue) ? 0 : startKmsValue, // Handle first entry
                endKms: parseFloat(document.getElementById('end-kms').value),
                exhaustedDate: null,
                totalKms: null,
                days: null,
                mileage: null,
            };
            newEntry.amount = newEntry.pricePerLiter * newEntry.volume;

            // 2. Validate KMs
            if (newEntry.endKms <= newEntry.startKms) {
                showImportModal(
                    'Invalid Odometer Reading',
                    'The "End KMS" must be greater than the "Start KMS". Please check your entry.',
                    'error'
                );
                return;
            }

            // 3. Find and update the *previous* entry
            let lastEntry = null;
            if (mileageData.length > 0) {
                lastEntry = mileageData[mileageData.length - 1];
            }
            
            let completedStats = null;
            if (lastEntry && !lastEntry.exhaustedDate) {
                // Calculate total KMs driven on the last tank
                // This is the difference between the NEW EndKMS and the PREVIOUS EndKMS (which is newEntry.startKms)
                const totalKmsDriven = newEntry.startKms - lastEntry.startKms;
                
                // Update the last entry (which we are now "completing")
                lastEntry.exhaustedDate = newEntry.filledDate;
                lastEntry.endKms = newEntry.startKms; // The "end" of the last tank is the "start" of this one
                lastEntry.totalKms = totalKmsDriven;
                lastEntry.mileage = totalKmsDriven / lastEntry.volume;
                lastEntry.days = (new Date(lastEntry.exhaustedDate) - new Date(lastEntry.filledDate)) / (1000 * 60 * 60 * 24);

                completedStats = {
                    mileage: lastEntry.mileage,
                    kms: lastEntry.totalKms,
                    days: lastEntry.days
                };
            }

            // 4. Create the *new* entry record (this one is now in-progress)
            // Its 'startKms' is the 'endKms' from the form (current odometer reading).
            // Its 'endKms' is null because it's the new in-progress tank.
            const newRecord = {
                id: mileageData.length + 1,
                filledDate: newEntry.filledDate,
                exhaustedDate: null,
                amount: newEntry.amount,
                pricePerLiter: newEntry.pricePerLiter,
                volume: newEntry.volume,
                startKms: newEntry.endKms, // The "start" of this new tank is the current odometer reading
                endKms: null, // This is now the in-progress tank
                totalKms: null,
                days: null,
                mileage: null,
            };
            
            // --- LOGIC ADJUSTMENT FOR FIRST ENTRY ---
            // If this is the *first* entry, the "lastEntry" logic is skipped.
            // We need to create a "dummy" previous entry to hold the starting odometer reading.
            if (mileageData.length === 0) {
                 const dummyFirstEntry = {
                    id: 0,
                    filledDate: newEntry.filledDate, // Assume same day for simplicity
                    exhaustedDate: newEntry.filledDate,
                    amount: 0,
                    pricePerLiter: 0,
                    volume: 0,
                    startKms: newEntry.startKms, // This is the user-provided start
                    endKms: newEntry.endKms, // This is the user-provided end
                    totalKms: newEntry.endKms - newEntry.startKms,
                    days: 0,
                    mileage: 0, // Can't calculate mileage for the first-ever tank
                 };
                 // We actually need to re-think.
                 // The *form* logic is wrong. Let's fix the form logic from the original file.
                 // The original logic was:
                 // 1. User fills tank. Enters "End KMS".
                 // 2. This "completes" the *previous* tank.
                 // 3. A *new* entry is created for the tank just filled.
                 
                 // Let's revert to the original logic, it was correct.
                 // My previous diagnosis was wrong.
                 
                 // RE-IMPLEMENTING ORIGINAL LOGIC
                 if (lastEntry) {
                    // This new fill-up "completes" the last entry
                    lastEntry.exhaustedDate = newEntry.filledDate;
                    lastEntry.totalKms = newEntry.endKms - lastEntry.startKms; // KMs driven on the *last* tank
                    lastEntry.mileage = lastEntry.totalKms / lastEntry.volume;
                    lastEntry.days = (new Date(lastEntry.exhaustedDate) - new Date(lastEntry.filledDate)) / (1000 * 60 * 60 * 24);

                    completedStats = {
                        mileage: lastEntry.mileage,
                        kms: lastEntry.totalKms,
                        days: lastEntry.days
                    };
                 }
                 
                 // 4. Create the *new* entry record (this one is now incomplete)
                 const newRecordForThisFill = {
                    id: mileageData.length + 1,
                    filledDate: newEntry.filledDate,
                    exhaustedDate: null,
                    amount: newEntry.amount,
                    pricePerLiter: newEntry.pricePerLiter,
                    volume: newEntry.volume,
                    startKms: newEntry.startKms, 
                    endKms: newEntry.endKms, // This is the current odometer reading
                    totalKms: null, // We don't know this yet
                    days: null, // We don't know this yet
                    mileage: null, // We don't know this yet
                 };
                 
                 // *** FIX for first entry ***
                 // If this is the first entry, StartKMS was editable.
                 // The "completedStats" will be null, which is correct.
                 if (mileageData.length === 0) {
                    newRecordForThisFill.startKms = newEntry.startKms; // Use the value from the form
                 } else {
                    newRecordForThisFill.startKms = lastEntry.endKms; // Use the previous entry's end
                 }
                 
                 // Validate again with the *correct* startKms
                 if (newRecordForThisFill.endKms <= newRecordForThisFill.startKms) {
                    showImportModal(
                        'Invalid Odometer Reading',
                        'The "End KMS" must be greater than the "Start KMS". Please check your entry.',
                        'error'
                    );
                    return;
                 }


                 // 5. Add new record to data
                 mileageData.push(newRecordForThisFill);
            }

            // 6. Save and update
            saveData();
            updateUI();
            addEntryForm.reset();

            // 7. Show summary modal
            showSummaryModal(completedStats, newRecordForThisFill.amount);

            // 8. Switch back to dashboard to see updated charts
            switchTab('dashboard');
        }

        /**
         * Updates all UI elements, stats, and charts with current data.
         */
        function updateUI() {
            if (mileageData.length === 0) {
                loadData(); // This will show the noDataMessage
                return;
            }

            // *** FIX: Ensure grid is visible and message is hidden *before* processing ***
            statsGrid.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Filter for completed entries (those with mileage)
            // The last entry is considered "in-progress" and excluded from stats
            const completedEntries = mileageData.filter(d => d.mileage && d.totalKms > 0);

            // Calculate Stats
            const totalKms = completedEntries.reduce((sum, d) => sum + d.totalKms, 0);
            const totalVolume = completedEntries.reduce((sum, d) => sum + d.volume, 0);
            const totalSpent = mileageData.reduce((sum, d) => sum + d.amount, 0); // Total spent on all fill-ups
            const avgMileage = completedEntries.length > 0 ? totalKms / totalVolume : 0;
            const firstDay = new Date(mileageData[0].filledDate);
            const lastDay = new Date(mileageData[mileageData.length - 1].filledDate);
            const totalDays = (lastDay - firstDay) / (1000 * 60 * 60 * 24);

            // Update Stats DOM
            document.getElementById('stat-total-kms').textContent = totalKms.toFixed(0);
            document.getElementById('stat-total-volume').textContent = totalVolume.toFixed(1);
            document.getElementById('stat-total-spent').textContent = `â‚¹${totalSpent.toFixed(0)}`;
            document.getElementById('stat-avg-mileage').textContent = avgMileage.toFixed(2);
            document.getElementById('stat-total-days').textContent = totalDays.toFixed(0);

            // --- Prepare Chart Data ---
            // Price Chart: All entries
            const priceChartData = mileageData.map(d => ({
                x: new Date(d.filledDate),
                y: d.pricePerLiter
            }));

            // Mileage Chart: Top 5 completed entries
            const topMileageEntries = [...completedEntries]
                .sort((a, b) => b.mileage - a.mileage)
                .slice(0, 5)
                .reverse(); // Reverse for bar chart display (lowest to highest)

            const mileageChartData = {
                labels: topMileageEntries.map(d => new Date(d.exhaustedDate).toLocaleDateString('en-CA')), // 'YYYY-MM-DD'
                datasets: [{
                    label: 'Mileage (Km/L)',
                    data: topMileageEntries.map(d => d.mileage),
                    backgroundColor: accentColorBar,
                    borderColor: accentColor,
                    borderWidth: 1
                }]
            };

            updateCharts(priceChartData, mileageChartData);
        }

        /**
         * Creates or updates the charts.
         */
        function updateCharts(priceData, mileageData) {
            // --- Price Chart (Line) ---
            const priceCtx = document.getElementById('price-chart').getContext('2d');
            
            // FIX: Create gradient for modern look
            const gradient = priceCtx.createLinearGradient(0, 0, 0, priceCtx.canvas.height);
            gradient.addColorStop(0, accentColorBg); // Start color
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)'); // End color (transparent)

            if (priceChart) {
                priceChart.data.datasets[0].data = priceData;
                priceChart.data.datasets[0].backgroundColor = gradient; // Re-assign gradient
                priceChart.update();
            } else {
                priceChart = new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Price per Liter (Rs)',
                            data: priceData,
                            borderColor: accentColor,
                            backgroundColor: gradient, // Use the gradient
                            fill: true,
                            tension: 0.4, // FIX: Smoother curve
                            pointRadius: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    tooltipFormat: 'yyyy-MM-dd'
                                },
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: titleColor
                                },
                                grid: { color: gridColor },
                                ticks: { color: tickColor }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Price (Rs)',
                                    color: titleColor
                                },
                                beginAtZero: false,
                                grid: { color: gridColor },
                                ticks: { color: tickColor }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: tooltipBgColor,
                                titleColor: titleColor,
                                bodyColor: tickColor
                            },
                            zoom: {
                                onZoomComplete: () => {
                                    resetZoomBtn.classList.remove('hidden');
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                },
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'x',
                                }
                            }
                        }
                    }
                });
            }

            // --- Mileage Chart (Bar) ---
            const mileageCtx = document.getElementById('mileage-chart').getContext('2d');
            if (mileageChart) {
                mileageChart.data.labels = mileageData.labels;
                mileageChart.data.datasets = mileageData.datasets;
                mileageChart.update();
            } else {
                mileageChart = new Chart(mileageCtx, {
                    type: 'bar',
                    data: mileageData,
                    options: {
                        indexAxis: 'y', // Horizontal bar chart
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Mileage (Km/L)',
                                    color: titleColor
                                },
                                grid: { color: gridColor },
                                ticks: { color: tickColor }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Tank Exhausted Date',
                                    color: titleColor
                                },
                                grid: { color: gridColor },
                                ticks: { color: tickColor }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false,
                                labels: { color: tickColor }
                            },
                            tooltip: {
                                backgroundColor: tooltipBgColor,
                                titleColor: titleColor,
                                bodyColor: tickColor
                            }
                        }
                    }
                });
            }
        }

        // --- FILE HANDLING ---

        /**
         * Handles the import of a CSV file.
         */
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                processData(text);
            };
            reader.readAsText(file);
            // Reset file input to allow importing the same file again
            csvFileInput.value = '';
        }

        /**
         * Processes the raw CSV text, validates, and imports it.
         */
        function processData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                showImportModal('Import Error', 'File is empty or invalid.', 'error');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // --- Smart Header Mapping ---
            // Create a map to find the index of each required column
            const headerMap = {
                id: findHeaderIndex(headers, ['id', 'S#']),
                filledDate: findHeaderIndex(headers, ['Filled', 'filledDate']),
                exhaustedDate: findHeaderIndex(headers, ['Exhausted', 'exhaustedDate']),
                amount: findHeaderIndex(headers, ['Filled Amount', 'amount']), // More specific name
                pricePerLiter: findHeaderIndex(headers, ['Per litre price', 'pricePerLiter', 'Per litre']),
                volume: findHeaderIndex(headers, ['Volume (Ltr)', 'volume']),
                startKms: findHeaderIndex(headers, ['Start KMS', 'startKms']),
                endKms: findHeaderIndex(headers, ['End KMS', 'endKms']),
                totalKms: findHeaderIndex(headers, ['Total', 'totalKMs', 'totalKms']),
                days: findHeaderIndex(headers, ['Days', 'days']),
                mileage: findHeaderIndex(headers, ['Mileage(Km/Ltr)', 'mileage'])
            };

            // --- Validation ---
            const missingHeaders = [];
            // Check for *absolutely essential* headers for the app to function
            if (headerMap.filledDate === -1) missingHeaders.push('Filled Date');
            if (headerMap.pricePerLiter === -1) missingHeaders.push('Price');
            if (headerMap.volume === -1) missingHeaders.push('Volume');
            // Start/End KMS are only essential if we can't find totalKms and mileage
            
            const hasOdometer = headerMap.startKms !== -1 && headerMap.endKms !== -1;
            const hasCalculated = headerMap.totalKms !== -1 && headerMap.mileage !== -1;

            if (!hasOdometer && !hasCalculated) {
                 missingHeaders.push('EITHER (Start KMS and End KMS) OR (Total KMs and Mileage)');
            }
            
            if (missingHeaders.length > 0) {
                showImportModal(
                    'Import Failed: Missing Columns',
                    `Your CSV file is missing required columns: <br/>- ${missingHeaders.join('<br/>- ')}. <br/>Please correct the file and try again.`,
                    'error'
                );
                return;
            }
            
            const importedData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length < headers.length) continue; // Skip malformed lines

                try {
                    const entry = {
                        id: (headerMap.id !== -1 && parseInt(values[headerMap.id])) || i,
                        filledDate: values[headerMap.filledDate],
                        exhaustedDate: (headerMap.exhaustedDate !== -1 && values[headerMap.exhaustedDate]) || null,
                        amount: (headerMap.amount !== -1 && parseFloat(values[headerMap.amount])) || 0,
                        pricePerLiter: parseFloat(values[headerMap.pricePerLiter]),
                        volume: parseFloat(values[headerMap.volume]),
                        startKms: (headerMap.startKms !== -1 && parseFloat(values[headerMap.startKms])) || 0,
                        endKms: (headerMap.endKms !== -1 && parseFloat(values[headerMap.endKms])) || 0,
                        totalKms: (headerMap.totalKms !== -1 && parseFloat(values[headerMap.totalKms])) || null,
                        days: (headerMap.days !== -1 && parseInt(values[headerMap.days])) || null,
                        mileage: (headerMap.mileage !== -1 && parseFloat(values[headerMap.mileage])) || null,
                    };
                    
                    // --- Data Recalculation ---
                    // 1. Recalculate amount if not present
                    if (entry.amount === 0 && entry.pricePerLiter && entry.volume) {
                        entry.amount = entry.pricePerLiter * entry.volume;
                    }
                    // 2. Recalculate totalKms if not present
                    if (entry.totalKms === null && hasOdometer) {
                        entry.totalKms = entry.endKms - entry.startKms;
                    }
                    // 3. Recalculate mileage if not present
                    if (entry.mileage === null && entry.totalKms > 0 && entry.volume > 0) {
                        entry.mileage = entry.totalKms / entry.volume;
                    }
                    // 4. Recalculate days if not present
                    if (entry.days === null && entry.exhaustedDate && entry.filledDate) {
                        entry.days = (new Date(entry.exhaustedDate) - new Date(entry.filledDate)) / (1000 * 60 * 60 * 24);
                    }

                    // Validate key data
                    if (!entry.filledDate || isNaN(entry.pricePerLiter) || isNaN(entry.volume)) {
                        console.warn('Skipping invalid line (missing date/price/volume):', lines[i]);
                        continue;
                    }
                     if (isNaN(entry.startKms) || isNaN(entry.endKms)) {
                        console.warn('Skipping invalid line (missing odometer):', lines[i]);
                        continue;
                    }

                    importedData.push(entry);
                } catch (err) {
                    console.error('Error parsing line:', lines[i], err);
                }
            }
            
            if (importedData.length === 0) {
                showImportModal('Import Error', 'No valid data rows could be read from the file.', 'error');
                return;
            }
            
            // Sort by fill date, as the CSV might not be in order
            importedData.sort((a, b) => new Date(a.filledDate) - new Date(b.filledDate));

            // --- FIX FOR COMPLETED CSV ---
            // If the last entry has mileage, it's a "complete" history.
            // We must mark it as "in-progress" for the app logic to work.
            const lastImportedEntry = importedData[importedData.length - 1];
            if (lastImportedEntry.mileage || lastImportedEntry.totalKms) {
                lastImportedEntry.exhaustedDate = null;
                lastImportedEntry.totalKms = null;
                lastImportedEntry.days = null;
                lastImportedEntry.mileage = null;
            }
            // -----------------------------

            mileageData = importedData;
            saveData();
            loadData(); // Reloads and re-sorts data, updates UI
            showImportModal('Import Successful', `Successfully imported ${importedData.length} entries.`, 'success');
        }
        
        /**
         * Helper to find a header index from a list of possible names.
         */
        function findHeaderIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const index = headers.findIndex(h => h.toLowerCase() === name.toLowerCase());
                if (index !== -1) return index;
            }
            return -1;
        }


        /**
         * Handles the export of data to a CSV file.
         */
        function handleFileExport() {
            if (mileageData.length === 0) {
                showImportModal('Export Failed', 'There is no data to export.', 'error');
                return;
            }

            const headers = [
                'id', 'filledDate', 'exhaustedDate', 'amount', 'pricePerLiter', 'volume',
                'startKms', 'endKms', 'totalKms', 'days', 'mileage'
            ];
            
            // Sort by date before exporting
            mileageData.sort((a, b) => new Date(a.filledDate) - new Date(b.filledDate));

            let csvContent = headers.join(',') + '\n';
            mileageData.forEach(row => {
                const values = [
                    row.id,
                    row.filledDate,
                    row.exhaustedDate || '',
                    row.amount.toFixed(2),
                    row.pricePerLiter.toFixed(2),
                    row.volume.toFixed(3),
                    row.startKms.toFixed(1),
                    row.endKms ? row.endKms.toFixed(1) : '', // Handle null endKms for in-progress
                    row.totalKms ? row.totalKms.toFixed(1) : '',
                    row.days || '',
                    row.mileage ? row.mileage.toFixed(2) : ''
                ];
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'mileage_data_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- MODAL CONTROLS ---

        /**
         * Shows the summary modal after adding an entry.
         */
        function showSummaryModal(completedStats, newCost) {
            if (completedStats) {
                document.getElementById('summary-mileage').parentElement.parentElement.style.display = 'block';
                document.getElementById('summary-mileage').textContent = `Mileage: ${completedStats.mileage.toFixed(2)} Km/L`;
                document.getElementById('summary-kms').textContent = `Distance: ${completedStats.kms.toFixed(1)} Kms`;
                document.getElementById('summary-days').textContent = `Duration: ${completedStats.days} days`;
            } else {
                // Hide stats if it's the first entry
                document.getElementById('summary-mileage').parentElement.parentElement.style.display = 'none';
            }
            document.getElementById('summary-cost').textContent = `Cost: â‚¹${newCost.toFixed(2)}`;

            showModal(summaryModal, summaryModalPanel);
        }

        /**
         * Shows the import status modal.
         */
        function showImportModal(title, message, type = 'success') {
            document.getElementById('import-modal-title').textContent = title;
            document.getElementById('import-modal-message').innerHTML = message; // Use innerHTML for line breaks

            const iconContainer = document.getElementById('import-modal-icon-container');
            if (type === 'success') {
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-800/30 sm:mx-0 sm:h-10 sm:w-10';
                iconContainer.innerHTML = `
                    <svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>`;
            } else { // 'error'
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-800/30 sm:mx-0 sm:h-10 sm:w-10';
                // --- FIXED TYPO HERE: class="..." not class-"..." ---
                iconContainer.innerHTML = `
                    <svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>`;
            }
            showModal(importModal, importModalPanel);
        }

        /**
         * Generic function to show a modal with animation.
         */
        function showModal(modal, panel) {
            modal.classList.remove('hidden');
            // Wait for next frame to apply transition
            requestAnimationFrame(() => {
                panel.classList.remove('opacity-0', 'translate-y-4', 'sm:scale-95');
                panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
            });
        }

        /**
         * Generic function to hide a modal with animation.
         */
        function hideModal(modal, panel) {
            panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            panel.classList.add('opacity-0', 'translate-y-4', 'sm:scale-95');
            // Wait for transition to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200); // Match transition duration
        }


        // --- STARTUP ---
        // Initialize the application once the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>

</html>

